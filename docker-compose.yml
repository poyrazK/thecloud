services:
  postgres:
    image: postgres:16-alpine
    # container_name: cloud-db
    environment:
      POSTGRES_USER: ${DB_USER:-cloud}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-cloud}
      POSTGRES_DB: ${DB_NAME:-cloud}
    ports:
      - "${DB_PORT_MAPPING:-5433:5432}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USER:-cloud} -d ${DB_NAME:-cloud}" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - cloud-network

  redis:
    image: redis:7-alpine
    # container_name: cloud-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - cloud-network

  jaeger:
    image: jaegertracing/all-in-one:1.54
    # container_name: cloud-jaeger
    ports:
      - "16686:16686" # Web UI
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - cloud-network

  powerdns:
    image: powerdns/pdns-auth-49:latest
    # container_name: thecloud-powerdns
    restart: unless-stopped
    ports:
      - "${DNS_PORT:-5354}:53/udp" # DNS queries (non-standard to avoid conflict)
      - "${DNS_PORT:-5354}:53/tcp"
      - "${POWERDNS_PORT:-8081}:8081" # REST API
    environment:
      - PDNS_AUTH_API=yes
      - PDNS_AUTH_API_KEY=${POWERDNS_API_KEY:-thecloud-dns-secret}
      - PDNS_AUTH_WEBSERVER=yes
      - PDNS_AUTH_WEBSERVER_ADDRESS=0.0.0.0
      - PDNS_AUTH_WEBSERVER_PORT=8081
      - PDNS_AUTH_WEBSERVER_ALLOW_FROM=0.0.0.0/0
      - PDNS_AUTH_LAUNCH=gsqlite3
      - PDNS_AUTH_GSQLITE3_DATABASE=/var/lib/powerdns/pdns.sqlite3
    volumes:
      - powerdns_data:/var/lib/powerdns
    networks:
      - cloud-network
    healthcheck:
      test: [ "CMD-SHELL", "bash -c 'echo > /dev/tcp/127.0.0.1/8081' || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  api:
    image: thecloud-api:latest
    build:
      context: .
      dockerfile: Dockerfile
    # container_name: cloud-api # Removed for scaling
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      powerdns:
        condition: service_healthy
    ports:
      - "${PORT:-8080}:${PORT:-8080}"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - PORT=${PORT:-8080}
      - DATABASE_URL=postgres://${DB_USER:-cloud}:${DB_PASSWORD:-cloud}@postgres:5432/${DB_NAME:-cloud}?sslmode=disable
      - DATABASE_READ_URL=${DATABASE_READ_URL}
      - DB_MAX_CONNS=100
      - DB_MIN_CONNS=${DB_MIN_CONNS:-2}
      - REDIS_URL=${REDIS_URL:-redis:6379}
      - APP_ENV=${APP_ENV:-development}
      - SECRETS_ENCRYPTION_KEY=${SECRETS_ENCRYPTION_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - COMPUTE_BACKEND=${COMPUTE_BACKEND:-docker}
      - RATE_LIMIT_GLOBAL=1000
      - RATE_LIMIT_AUTH=3000
      - TRACING_ENABLED=${TRACING_ENABLED:-false}
      - JAEGER_ENDPOINT=http://jaeger:4318
      - POWERDNS_API_URL=http://powerdns:8081
      - POWERDNS_API_KEY=${POWERDNS_API_KEY:-thecloud-dns-secret}
      - DOCKER_DEFAULT_NETWORK=${DOCKER_DEFAULT_NETWORK:-cloud-network}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/run/openvswitch:/var/run/openvswitch
      - ./thecloud-data:/app/thecloud-data
    networks:
      - cloud-network

volumes:
  postgres_data:
  powerdns_data:


networks:
  cloud-network:
    name: cloud-network
