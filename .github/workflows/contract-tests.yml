name: API Contract Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  schemathesis:
    name: OpenAPI Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Build and Start API
        run: |
          go build -o thecloud-api ./cmd/api
          ./thecloud-api &
          # Wait for API to be ready
          for i in {1..30}; do
            curl -s http://localhost:8080/health && break || sleep 1
          done

      - name: Run Schemathesis
        uses: schemathesis/action@v2
        with:
          schema: './docs/swagger/swagger.json'
          base-url: 'http://localhost:8080'
          args: '--checks all'
        continue-on-error: true # API might need DB/Services to pass all checks, so we start with warning
